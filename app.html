<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tournoi ‚Äî Application</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1220">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    html,body{height:100%;margin:0}
    body{background:#0b1220;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .topbar{position:sticky;top:0;z-index:50;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      padding:10px 12px;background:rgba(17,24,39,.86);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
      border-bottom:1px solid rgba(255,255,255,.12);color:#fff}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;
      background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.16);font-weight:800;font-size:.9rem}
    .btn{cursor:pointer;border:0;border-radius:12px;padding:9px 12px;font-weight:900;color:#fff;
      background:linear-gradient(135deg,#2563eb,#7c3aed)}
    .btn.secondary{background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.16)}
    iframe{border:0;width:100%;height:calc(100vh - 62px);background:#fff}
    @media (max-width: 520px){ iframe{height:calc(100vh - 92px)} }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="pill" id="status">V√©rification acc√®s‚Ä¶</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button class="btn secondary" id="btnSync" title="Sauvegarder une copie en ligne (Firebase)">Sync Cloud</button>
      <button class="btn secondary" id="btnDownload" title="Sauvegarder une copie locale (fichier)">Export local</button>
      <button class="btn secondary" id="btnUpload" title="Recharger une copie locale (fichier)">Import local</button>
      <button class="btn" id="btnLogout">D√©connexion</button>
      <input id="file" type="file" accept="application/json" style="display:none" />
    </div>
  </div>

  <iframe id="appFrame" src="./app-inner.html"></iframe>

  <script type="module">
    import { requireAccessOrRedirect } from "./js/gate.js";
    import { logout, waitForAuthReady } from "./js/auth.js";
    import { ensureUserProfile, computeAccess } from "./js/license.js";
    import { cloudSaveSnapshot } from "./js/storage.js";

    const status = document.getElementById("status");
    const btnLogout = document.getElementById("btnLogout");
    const btnSync = document.getElementById("btnSync");
    const btnDownload = document.getElementById("btnDownload");
    const btnUpload = document.getElementById("btnUpload");
    const file = document.getElementById("file");
    const frame = document.getElementById("appFrame");

    function setStatus(text){ status.textContent = text; }

    function downloadJSON(filename, obj){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    function getAllLocalStorage(){
      const out = {};
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        out[k] = localStorage.getItem(k);
      }
      return out;
    }

    function setAllLocalStorage(d){
      for(const [k,v] of Object.entries(d||{})){
        localStorage.setItem(k, v);
      }
    }

    btnLogout.onclick = async ()=>{ await logout(); location.href="./login.html"; };

    btnDownload.onclick = async ()=>{
      const user = await waitForAuthReady();
      const payload = { exportedAt: Date.now(), email: user?.email||"", localStorage: getAllLocalStorage() };
      downloadJSON("tournoi_backup_local.json", payload);
    };

    btnUpload.onclick = ()=> file.click();
    file.onchange = async ()=>{
      const f = file.files?.[0];
      if(!f) return;
      const txt = await f.text();
      const data = JSON.parse(txt);
      if(!data?.localStorage) { alert("Fichier invalide"); return; }
      setAllLocalStorage(data.localStorage);
      frame.src = frame.src;
      alert("Import OK. L'application a √©t√© recharg√©e.");
      file.value="";
    };

    btnSync.onclick = async ()=>{
      try{
        if(!navigator.onLine) { alert("Internet requis pour Sync Cloud."); return; }
        const ctx = await requireAccessOrRedirect();
        if(!ctx) return;
        const snapshot = { savedAt: Date.now(), localStorage: getAllLocalStorage() };
        await cloudSaveSnapshot(ctx.user, snapshot.localStorage);
        alert("Sauvegarde cloud OK (snapshot).");
      }catch(e){
        alert(e?.message || "Sync cloud impossible");
      }
    };

    (async ()=>{
      const ctx = await requireAccessOrRedirect();
      if(!ctx) return;

      if(ctx.offline){
        setStatus("üü° Offline ‚Äî licence valid√©e r√©cemment");
        return;
      }

      const access = ctx.access;
      if(access.mode==="license"){
        setStatus("‚úÖ Licence active ("+Math.floor(access.remainingSec/86400)+" j restants)");
      }else{
        setStatus("‚è±Ô∏è Essai: "+access.remainingSec+" sec restants");
        setInterval(async ()=>{
          const user = await waitForAuthReady();
          if(!user) return;
          if(!navigator.onLine){
            location.href="./login.html";
            return;
          }
          const profile = await ensureUserProfile(user);
          const a = computeAccess(profile);
          if(!a.allowed){ location.href="./activate.html"; return; }
          setStatus("‚è±Ô∏è Essai: "+a.remainingSec+" sec restants");
        }, 1000);
      }
    })();
  </script>
</body>
</html>
