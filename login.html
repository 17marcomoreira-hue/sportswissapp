<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tournois ‚Äî Connexion</title>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="theme-color" content="#ffffff">

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0b1220;
      --muted:rgba(11,18,32,.62);
      --line:rgba(11,18,32,.10);
      --shadow:0 12px 30px rgba(15,23,42,.08);
      --brand:#2563eb;
      --brand2:#1d4ed8;
      --ok:rgba(22,163,74,.10);
      --okLine:rgba(22,163,74,.22);
      --err:rgba(239,68,68,.10);
      --errLine:rgba(239,68,68,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(180deg,#f6f7fb, #eef2ff);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .wrap{width:100%;max-width:520px}
    .header{
      display:flex;align-items:center;gap:10px;margin-bottom:12px;
    }
    .logo{
      width:46px;height:46px;border-radius:14px;
      background:#fff;box-shadow:var(--shadow);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .logo img{width:42px;height:42px;object-fit:contain}
    h1{font-size:20px;margin:0}
    .muted{color:var(--muted);font-size:13px;line-height:1.4}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:16px;
    }

    .tabs{
      display:flex;
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      margin-bottom:12px;
      background:#fff;
    }
    .tab{
      flex:1;
      padding:10px 12px;
      text-align:center;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
      user-select:none;
      color:rgba(11,18,32,.72);
    }
    .tab.active{
      background:rgba(37,99,235,.10);
      color:var(--brand2);
    }

    .panel{display:none}
    .panel.active{display:block}

    label{display:block;font-size:13px;font-weight:600;margin:10px 0 6px}
    input{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
      font-size:15px;
      background:#fff;
    }
    input:focus{border-color:rgba(37,99,235,.35);box-shadow:0 0 0 4px rgba(37,99,235,.12)}

    .row{
      display:flex;gap:10px;align-items:center;margin-top:12px;
    }
    .btn{
      width:100%;
      background:linear-gradient(180deg,var(--brand),var(--brand2));
      color:#fff;
      border:none;
      border-radius:14px;
      padding:12px 14px;
      font-weight:800;
      cursor:pointer;
      font-size:15px;
      box-shadow:0 10px 18px rgba(37,99,235,.18);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btnGhost{
      background:transparent;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 14px;
      cursor:pointer;
      font-weight:700;
      width:100%;
    }
    .msg{
      margin-top:10px;
      border-radius:12px;
      padding:10px 12px;
      display:none;
      font-size:14px;
      line-height:1.35;
    }
    .msg.ok{display:block;background:var(--ok);border:1px solid var(--okLine);color:rgba(22,163,74,.95)}
    .msg.err{display:block;background:var(--err);border:1px solid var(--errLine);color:rgba(185,28,28,.95)}

    .foot{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-size:13px;
      color:var(--muted);
    }
    a{color:var(--brand2);text-decoration:none;font-weight:700}
    a:hover{text-decoration:underline}

    .feat{
      margin-top:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.7);
      font-size:13px;
      color:rgba(11,18,32,.78);
      display:flex;
      justify-content:space-between;
      gap:12px;
    }
    .feat b{color:rgba(11,18,32,.9)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="logo">
        <img src="icons/icon-192.png" alt="Logo">
      </div>
      <div>
        <h1>Connexion</h1>
        <div class="muted">Compte + licence annuelle (un appareil √† la fois).</div>
      </div>
    </div>

    <div class="card">
      <div class="tabs" role="tablist" aria-label="Connexion / Inscription">
        <div class="tab active" id="tabLogin" role="tab" aria-selected="true">Se connecter</div>
        <div class="tab" id="tabSignup" role="tab" aria-selected="false">Cr√©er un compte</div>
      </div>

      <div class="panel active" id="panelLogin">
        <label for="emailLogin">Email</label>
        <input id="emailLogin" type="email" autocomplete="email" placeholder="nom@exemple.com">

        <label for="passwordLogin">Mot de passe</label>
        <input id="passwordLogin" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">

        <div class="row">
          <button class="btn" id="btnLogin" type="button">Se connecter</button>
        </div>

        <div class="foot">
          <span>Mot de passe oubli√© ?</span>
          <a href="#" id="btnReset">R√©initialiser</a>
        </div>
      </div>

      <div class="panel" id="panelSignup">
        <label for="emailSignup">Email</label>
        <input id="emailSignup" type="email" autocomplete="email" placeholder="nom@exemple.com">

        <label for="passwordSignup">Mot de passe</label>
        <input id="passwordSignup" type="password" autocomplete="new-password" placeholder="6 caract√®res minimum">

        <label for="passwordSignup2">Confirmer le mot de passe</label>
        <input id="passwordSignup2" type="password" autocomplete="new-password" placeholder="R√©p√©ter le mot de passe">

        <div class="row">
          <button class="btn" id="btnSignup" type="button">Cr√©er le compte</button>
        </div>

        <div class="feat">
          <b>üîí Acc√®s s√©curis√©</b>
          <span>V√©rification email obligatoire avant de d√©marrer.</span>
        </div>
      </div>

      <div id="msg" class="msg"></div>
    </div>
  </div>

  <script type="module">
    import { login, signup, resetPassword, reloadCurrentUser } from "./js/auth.js";
    import { ensureUserProfile, computeAccess, enforceSingleDevice } from "./js/license.js";

    const $ = (id)=>document.getElementById(id);
    const msg = $("msg");

    const tabLogin = $("tabLogin");
    const tabSignup = $("tabSignup");
    const panelLogin = $("panelLogin");
    const panelSignup = $("panelSignup");

    const emailLogin = $("emailLogin");
    const passwordLogin = $("passwordLogin");
    const btnLogin = $("btnLogin");

    const emailSignup = $("emailSignup");
    const passwordSignup = $("passwordSignup");
    const passwordSignup2 = $("passwordSignup2");
    const btnSignup = $("btnSignup");

    function show(type, text){
      msg.className = "msg " + (type==="ok" ? "ok" : "err");
      msg.textContent = text;
      msg.style.display = "block";
    }
    function clearMsg(){ msg.style.display = "none"; }

    function setTab(mode){
      clearMsg();
      const isLogin = mode === "login";
      tabLogin.classList.toggle("active", isLogin);
      tabSignup.classList.toggle("active", !isLogin);
      panelLogin.classList.toggle("active", isLogin);
      panelSignup.classList.toggle("active", !isLogin);
    }
    tabLogin.onclick = ()=>setTab("login");
    tabSignup.onclick = ()=>setTab("signup");

    function canLogin(){
      return emailLogin.value.trim().includes("@") && passwordLogin.value.length >= 1;
    }
    function canSignup(){
      const e = emailSignup.value.trim();
      const p1 = passwordSignup.value;
      const p2 = passwordSignup2.value;
      return e.includes("@") && p1.length >= 6 && p1 === p2;
    }
    function refreshButtons(){
      btnLogin.disabled = !canLogin();
      btnSignup.disabled = !canSignup();
    }
    [emailLogin,passwordLogin,emailSignup,passwordSignup,passwordSignup2].forEach(el=>{
      el.addEventListener("input", refreshButtons);
    });
    refreshButtons();

    function getNext(){
      const p = new URLSearchParams(location.search);
      const next = p.get("next");
      return next ? decodeURIComponent(next) : null;
    }

    async function afterAuth(){
      if(!navigator.onLine){
        show("err","Connexion internet requise pour la premi√®re connexion.");
        return;
      }

      // ‚úÖ IMPORTANT : rafra√Æchir l‚Äôutilisateur pour avoir emailVerified √† jour
      const freshUser = await reloadCurrentUser();
      if(!freshUser){
        show("err","Non connect√©. Merci de r√©essayer.");
        return;
      }

      // ‚úÖ Bloque tant que l‚Äôemail n‚Äôest pas v√©rifi√© (sur user ‚Äúfresh‚Äù)
      if(!freshUser.emailVerified){
        location.href = "./verify.html";
        return;
      }

      await enforceSingleDevice(freshUser);
      const profile = await ensureUserProfile(freshUser);
      const access = computeAccess(profile);

      const next = getNext();
      if(access.allowed){
        location.href = next || "./app.html";
      }else{
        location.href = "./activate.html";
      }
    }

    btnLogin.onclick = async ()=>{
      clearMsg();
      try{
        const email = emailLogin.value.trim();
        const pass = passwordLogin.value;
        await login(email, pass);
        await afterAuth();
      }catch(e){
        show("err", e?.message || "Erreur de connexion");
      }
    };

    btnSignup.onclick = async ()=>{
      clearMsg();
      try{
        const email = emailSignup.value.trim();
        const p1 = passwordSignup.value;
        const p2 = passwordSignup2.value;

        if(p1.length < 6) throw new Error("Mot de passe : 6 caract√®res minimum");
        if(p1 !== p2) throw new Error("Les mots de passe ne correspondent pas.");

        await signup(email, p1);

        show("ok","Compte cr√©√©. V√©rifie ton email (spams/ind√©sirables) pour d√©marrer l‚Äôessai.");
        setTimeout(()=>location.href="./verify.html", 600);

      }catch(e){
        show("err", e?.message || "Erreur de cr√©ation de compte");
      }
    };

    $("btnReset").onclick = async ()=>{
      clearMsg();
      try{
        const email = emailLogin.value.trim();
        if(!email) throw new Error("Entre ton email d‚Äôabord (onglet Se connecter).");
        await resetPassword(email);
        show("ok", "Email de r√©initialisation envoy√©. V√©rifie ta bo√Æte mail et aussi les spams/ind√©sirables.");
      }catch(e){
        show("err", e?.message || "Impossible d'envoyer l'email");
      }
    };
  </script>
</body>
</html>





