<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tournoi ‚Äî Connexion</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1220">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    :root{--bg:#0b1220;--card:rgba(255,255,255,.92);--text:#0b1220;--muted:rgba(11,18,32,.70)}
    body{margin:0;min-height:100vh;display:grid;place-items:center;
      background:
        radial-gradient(900px 700px at 15% 0%, rgba(37,99,235,.18), transparent 55%),
        radial-gradient(900px 700px at 100% 15%, rgba(34,197,94,.12), transparent 55%),
        radial-gradient(900px 700px at 55% 110%, rgba(236,72,153,.10), transparent 60%),
        var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#fff;}
    .wrap{width:min(980px,94vw);display:grid;gap:14px;grid-template-columns: 1.05fr .95fr;align-items:start}
    @media (max-width: 880px){ .wrap{grid-template-columns:1fr} }
    .card{background:var(--card);color:var(--text);border:1px solid rgba(11,18,32,.14);
      border-radius:18px;box-shadow:0 18px 40px rgba(0,0,0,.35);padding:16px;}
    h1{margin:4px 0 6px;font-size:1.35rem;}
    .muted{color:var(--muted);font-size:.92rem;line-height:1.35}
    label{display:block;margin:10px 0 6px;color:var(--muted);font-size:.9rem}
    input{width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(11,18,32,.18);font-size:16px;outline:none;}
    input:focus{box-shadow:0 0 0 4px rgba(37,99,235,.18);border-color:rgba(37,99,235,.35)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    button{cursor:pointer;border:0;border-radius:12px;padding:11px 14px;font-weight:900}
    .btn{background:linear-gradient(135deg,#2563eb,#7c3aed);color:#fff;flex:1}
    .btn2{background:#fff;border:1px solid rgba(11,18,32,.18);color:#111827}
    .btn:disabled,.btn2:disabled{opacity:.55;cursor:not-allowed}
    .link{background:transparent;border:0;color:#2563eb;font-weight:900;padding:0}
    .msg{margin-top:10px;border-radius:12px;padding:10px 12px;display:none}
    .msg.ok{display:block;background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.25)}
    .msg.err{display:block;background:rgba(239,68,68,.10);border:1px solid rgba(239,68,68,.25)}
    .top{display:flex;gap:12px;align-items:center}
    .logo{width:54px;height:54px;border-radius:16px;background:linear-gradient(135deg,#4f46e5,#10b981);display:grid;place-items:center;overflow:hidden}
    .logo img{width:42px;height:42px;object-fit:contain}
    .tabs{display:flex;gap:8px;margin-top:12px}
    .tab{flex:1;border-radius:12px;border:1px solid rgba(11,18,32,.14);padding:10px 12px;background:rgba(255,255,255,.65);
      font-weight:900;color:#111827}
    .tab.active{background:#fff;box-shadow:0 10px 24px rgba(0,0,0,.10)}
    .panel{display:none;margin-top:10px}
    .panel.active{display:block}

    /* Badge lisible sur fond sombre */
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.22);
      color:rgba(255,255,255,.95);
      font-weight:900;font-size:.95rem
    }

    .features{display:grid;gap:10px;margin-top:12px}
    .feat{background:rgba(255,255,255,.72);border:1px solid rgba(11,18,32,.12);border-radius:16px;padding:12px}
    .feat b{display:block;margin-bottom:4px}
    .hero h2{margin:6px 0 6px;font-size:1.2rem;color:#fff}
    .hero p{margin:0;color:rgba(255,255,255,.82);line-height:1.45}
    .heroCard{background:rgba(17,24,39,.70);border:1px solid rgba(255,255,255,.14);border-radius:18px;padding:16px;
      box-shadow:0 18px 40px rgba(0,0,0,.35)}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;
      background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.16);font-weight:900}
    .footer{margin-top:12px;color:rgba(11,18,32,.58);font-size:.85rem;text-align:center}
    .hint{margin-top:8px;font-size:.85rem;color:rgba(11,18,32,.62)}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Pr√©sentation / ‚Äúpub‚Äù -->
    <div class="heroCard hero">
      <div class="badge">üèÜ Gestion de tournois ‚Äî simple, rapide, pro</div>
      <h2>Cr√©e ton tournoi en quelques clics</h2>
      <p>
        Planifie les matchs, saisis les scores, exporte des documents, et garde une sauvegarde de tes tournois.
        Parfait pour √©coles, clubs et √©v√©nements.
      </p>

      <p style="margin-top:10px;color:rgba(255,255,255,.82);line-height:1.45">
        Cr√©e aussi <b>plusieurs tournois en parall√®le</b> pour diff√©rentes classes ou groupes d‚Äôentra√Ænement.
      </p>

      <div style="margin-top:12px" class="pill">üéÅ Essai gratuit : <span>10 minutes</span> d√®s la cr√©ation du compte</div>

      <div class="features">
        <div class="feat"><b>üìÖ Organisation claire</b><span class="muted">Calendrier, terrains, rounds et suivi des r√©sultats.</span></div>
        <div class="feat"><b>üßæ Feuilles arbitres par terrain</b><span class="muted">Imprime des feuilles pr√™tes √† l‚Äôemploi pour chaque terrain et chaque horaire.</span></div>
        <div class="feat"><b>üéæ Mode ATP automatique</b><span class="muted">Un mode con√ßu pour int√©grer de la diff√©renciation dans ton enseignement et tes entra√Ænements.</span></div>
        <div class="feat"><b>üíæ Sauvegarde</b><span class="muted">Ne perdez rien : sauvegarde sur l‚Äôappareil + sauvegarde en ligne (si connect√©).</span></div>
      </div>

      <div style="margin-top:12px" class="muted">
        Astuce : l‚Äôoffline est possible si la licence a √©t√© valid√©e r√©cemment.
      </div>
    </div>

    <!-- Login / Signup -->
    <div class="card">
      <div class="top">
        <div class="logo"><img src="icons/icon-192.png" alt=""></div>
        <div>
          <h1>Connexion</h1>
          <div class="muted">Acc√®de √† l‚Äôessai gratuit, ou active ta licence.</div>
        </div>
      </div>

      <div class="msg" id="msg"></div>

      <div class="tabs" role="tablist" aria-label="Connexion ou cr√©ation de compte">
        <button class="tab active" id="tabLogin" type="button">Se connecter</button>
        <button class="tab" id="tabSignup" type="button">Cr√©er un compte</button>
      </div>

      <!-- Panel login -->
      <div class="panel active" id="panelLogin">
        <label>Email</label>
        <input id="emailLogin" type="email" autocomplete="email" placeholder="ex: prenom.nom@email.com"/>

        <label>Mot de passe</label>
        <input id="passwordLogin" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>

        <div class="row">
          <button class="btn" id="btnLogin" disabled>Se connecter</button>
        </div>

        <div class="row" style="justify-content:space-between">
          <button class="link" id="btnReset" type="button">Mot de passe perdu</button>
        </div>

        <div class="hint">Apr√®s clic, v√©rifie aussi les <b>spams / ind√©sirables</b> si tu ne vois pas l‚Äôemail.</div>
      </div>

      <!-- Panel signup -->
      <div class="panel" id="panelSignup">
        <label>Email</label>
        <input id="emailSignup" type="email" autocomplete="email" placeholder="ex: prenom.nom@email.com"/>

        <label>Mot de passe</label>
        <input id="passwordSignup" type="password" autocomplete="new-password" placeholder="6 caract√®res minimum"/>

        <label>Confirmer le mot de passe</label>
        <input id="passwordSignup2" type="password" autocomplete="new-password" placeholder="R√©p√®te le mot de passe"/>

        <div class="row">
          <button class="btn2" id="btnSignup" disabled>Cr√©er un compte</button>
        </div>

        <div class="hint">L‚Äôessai gratuit d√©marre juste apr√®s la cr√©ation du compte (10 minutes).</div>
      </div>

      <div class="footer">D√©velopp√© par <b>Marco Moreira-Perriard</b></div>
    </div>
  </div>

  <script type="module">
    import { login, signup, resetPassword } from "./js/auth.js";
    import { ensureUserProfile, computeAccess, enforceSingleDevice } from "./js/license.js";

    const $ = (id)=>document.getElementById(id);
    const msg = $("msg");

    const tabLogin = $("tabLogin");
    const tabSignup = $("tabSignup");
    const panelLogin = $("panelLogin");
    const panelSignup = $("panelSignup");

    const emailLogin = $("emailLogin");
    const passwordLogin = $("passwordLogin");
    const btnLogin = $("btnLogin");

    const emailSignup = $("emailSignup");
    const passwordSignup = $("passwordSignup");
    const passwordSignup2 = $("passwordSignup2");
    const btnSignup = $("btnSignup");

    function show(type, text){
      msg.className = "msg " + (type==="ok" ? "ok" : "err");
      msg.textContent = text;
      msg.style.display = "block";
    }
    function clearMsg(){ msg.style.display = "none"; }

    function setTab(mode){
      clearMsg();
      const isLogin = mode === "login";
      tabLogin.classList.toggle("active", isLogin);
      tabSignup.classList.toggle("active", !isLogin);
      panelLogin.classList.toggle("active", isLogin);
      panelSignup.classList.toggle("active", !isLogin);
    }
    tabLogin.onclick = ()=>setTab("login");
    tabSignup.onclick = ()=>setTab("signup");

    function canLogin(){
      return emailLogin.value.trim().includes("@") && passwordLogin.value.length >= 1;
    }
    function canSignup(){
      const e = emailSignup.value.trim();
      const p1 = passwordSignup.value;
      const p2 = passwordSignup2.value;
      return e.includes("@") && p1.length >= 6 && p1 === p2;
    }
    function refreshButtons(){
      btnLogin.disabled = !canLogin();
      btnSignup.disabled = !canSignup();
    }
    [emailLogin,passwordLogin,emailSignup,passwordSignup,passwordSignup2].forEach(el=>{
      el.addEventListener("input", refreshButtons);
    });
    refreshButtons();

    async function afterAuth(user){
      if(!navigator.onLine){
        show("err","Connexion internet requise pour la premi√®re connexion.");
        return;
      }
      await enforceSingleDevice(user);
      const profile = await ensureUserProfile(user);
      const access = computeAccess(profile);
      location.href = access.allowed ? "./app.html" : "./activate.html";
    }

    btnLogin.onclick = async ()=>{
      clearMsg();
      try{
        const email = emailLogin.value.trim();
        const pass = passwordLogin.value;
        const user = await login(email, pass);
        await afterAuth(user);
      }catch(e){
        show("err", e?.message || "Erreur de connexion");
      }
    };

    btnSignup.onclick = async ()=>{
      clearMsg();
      try{
        const email = emailSignup.value.trim();
        const p1 = passwordSignup.value;
        const p2 = passwordSignup2.value;
        if(p1.length < 6) throw new Error("Mot de passe : 6 caract√®res minimum");
        if(p1 !== p2) throw new Error("Les mots de passe ne correspondent pas.");
        const user = await signup(email, p1);
        await afterAuth(user);
      }catch(e){
        show("err", e?.message || "Erreur de cr√©ation de compte");
      }
    };

    $("btnReset").onclick = async ()=>{
      clearMsg();
      try{
        const email = emailLogin.value.trim();
        if(!email) throw new Error("Entre ton email d‚Äôabord (onglet Se connecter).");
        await resetPassword(email);
        show("ok", "Email de r√©initialisation envoy√©. V√©rifie ta bo√Æte mail et aussi les spams/ind√©sirables.");
      }catch(e){
        show("err", e?.message || "Impossible d'envoyer l'email");
      }
    };
  </script>
</body>
</html>
