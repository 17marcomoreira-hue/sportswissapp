<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tournois ‚Äî Connexion</title>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="theme-color" content="#ffffff">

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0b1220;
      --muted:rgba(11,18,32,.62);
      --line:rgba(11,18,32,.10);
      --shadow:0 18px 45px rgba(15,23,42,.10);
      --radius:18px;
      --blue:#2563eb;
      --purple:#7c3aed;
      --green:#16a34a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 550px at 15% 10%, rgba(37,99,235,.18), transparent 55%),
        radial-gradient(900px 550px at 95% 20%, rgba(124,58,237,.14), transparent 60%),
        radial-gradient(900px 550px at 45% 105%, rgba(22,163,74,.10), transparent 60%),
        var(--bg);
    }

    .wrap{width:min(1100px,92vw); margin:28px auto 22px;}
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px; padding:10px 4px 16px;
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg,var(--blue),var(--purple));
      display:grid;place-items:center; overflow:hidden;
      box-shadow:0 12px 28px rgba(37,99,235,.25);
    }
    .logo img{
      width:30px;height:30px;object-fit:contain;
      filter:drop-shadow(0 2px 6px rgba(0,0,0,.25));
    }
    .brandTitle{font-weight:950; letter-spacing:.2px}
    .topNote{color:var(--muted); font-weight:800; font-size:.92rem}

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns:1fr}
      header{flex-direction:column; align-items:flex-start}
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    /* HERO */
    .hero{padding:22px}
    .kicker{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 12px; border-radius:999px;
      background:rgba(37,99,235,.08);
      border:1px solid rgba(37,99,235,.18);
      color:rgba(37,99,235,.95);
      font-weight:950;
      letter-spacing:.1px;
    }
    .hero h1{
      margin:14px 0 10px;
      font-size:2.05rem;
      line-height:1.08;
      letter-spacing:-.4px;
    }
    .hero p{margin:0; color:var(--muted); line-height:1.55; font-size:1.02rem}

    .badges{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 11px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(11,18,32,.03);
      font-weight:900;
      color:rgba(11,18,32,.86);
      user-select:none;
    }
    .badge strong{color:var(--text)}

    .features{
      margin-top:16px;
      display:grid; gap:10px;
      grid-template-columns:1fr 1fr;
    }
    @media (max-width: 560px){ .features{grid-template-columns:1fr} }
    .feat{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(11,18,32,.02), rgba(11,18,32,.00));
    }
    .feat b{display:block; margin-bottom:4px}
    .feat span{color:var(--muted); line-height:1.45}

    /* LOGIN CARD */
    .auth{padding:18px}
    .authHead{display:flex; gap:12px; align-items:center}
    .authHead h2{margin:0; font-size:1.25rem; letter-spacing:-.2px}
    .authHead .sub{color:var(--muted); margin-top:2px; font-weight:700}

    .tabs{display:flex; gap:8px; margin-top:14px}
    .tab{
      flex:1;
      border-radius:14px;
      border:1px solid var(--line);
      padding:10px 12px;
      background:rgba(11,18,32,.02);
      font-weight:950;
      color:rgba(11,18,32,.86);
      cursor:pointer;
    }
    .tab.active{background:#fff; box-shadow:0 10px 26px rgba(15,23,42,.08)}

    .panel{display:none; margin-top:12px}
    .panel.active{display:block}

    label{display:block; margin:10px 0 6px; color:var(--muted); font-size:.92rem; font-weight:800}
    input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(11,18,32,.16);
      font-size:16px;
      outline:none;
      background:#fff;
    }
    input:focus{
      border-color:rgba(37,99,235,.40);
      box-shadow:0 0 0 4px rgba(37,99,235,.14);
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px}
    button{
      cursor:pointer;
      border:0;
      border-radius:14px;
      padding:12px 14px;
      font-weight:950;
      letter-spacing:.1px;
    }
    .btn{
      flex:1;
      color:#fff;
      background:linear-gradient(135deg,var(--blue),var(--purple));
      box-shadow:0 14px 26px rgba(37,99,235,.18);
    }
    .btn2{
      flex:1;
      background:#fff;
      border:1px solid rgba(11,18,32,.16);
      color:rgba(11,18,32,.92);
    }
    .btn:disabled,.btn2:disabled{opacity:.55; cursor:not-allowed}
    .link{
      background:transparent;
      border:0;
      padding:0;
      color:var(--blue);
      font-weight:950;
      cursor:pointer;
    }

    .msg{
      margin-top:12px;
      border-radius:14px;
      padding:10px 12px;
      display:none;
      font-weight:800;
    }
    .msg.ok{display:block;background:rgba(22,163,74,.10);border:1px solid rgba(22,163,74,.22);color:rgba(22,163,74,.95)}
    .msg.err{display:block;background:rgba(239,68,68,.10);border:1px solid rgba(239,68,68,.22);color:rgba(185,28,28,.95)}
    .hint{margin-top:10px; font-size:.9rem; color:var(--muted); line-height:1.35}
    .fine{margin-top:10px; font-size:.84rem; color:rgba(11,18,32,.55); text-align:center; padding:10px 0 2px}

    footer{
      margin:16px 0 0;
      text-align:center;
      color:rgba(11,18,32,.55);
      font-size:.88rem;
      font-weight:750;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">
          <img src="icons/icon-192.png" alt="">
        </div>
        <div>
          <div class="brandTitle">Tournois</div>
          <div class="topNote">Gestion de tournois ‚Äî simple, rapide, pro</div>
        </div>
      </div>
      <div class="topNote">‚úÖ Recommand√© : iPad / tablette / ordinateur ‚Ä¢ ‚úÖ Aucun t√©l√©chargement requis ‚Ä¢ ‚úÖ Aucune publicit√©</div>
    </header>

    <div class="grid">
      <!-- HERO -->
      <section class="card">
        <div class="hero">
          <div class="kicker">üéÅ Essai gratuit : <strong>10 minutes</strong> d√®s la cr√©ation du compte</div>

          <h1>Cr√©e ton tournoi en quelques clics.</h1>
          <p>
            Planifie les matchs, saisis les scores et imprime des feuilles pr√™tes √† l‚Äôemploi.
            Parfait pour √©coles, clubs et √©v√©nements ‚Äî avec la possibilit√© de g√©rer <b>plusieurs tournois en parall√®le</b>.
          </p>

          <div class="badges">
            <div class="badge">üßæ <strong>Feuilles par terrain</strong> (horaire + espace score)</div>
            <div class="badge">üìÑ <strong>Feuilles par √©quipe</strong> (horaire + terrain)</div>
            <div class="badge">üéæ <strong>Mode ATP automatique</strong> (diff√©renciation)</div>
            <div class="badge">üíæ <strong>Sauvegarde</strong> locale + en ligne</div>
          </div>

          <div class="features">
            <div class="feat"><b>üìÖ Organisation claire</b><span>Terrains, rounds, planning et classement en un coup d‚Äô≈ìil.</span></div>
            <div class="feat"><b>üñ®Ô∏è Exports professionnels</b><span>PDF/feuilles pr√™tes pour arbitres et √©quipes.</span></div>
            <div class="feat"><b>üîí Acc√®s s√©curis√©</b><span>Compte + licence annuelle (un appareil √† la fois).</span></div>
            <div class="feat"><b>‚ö° Fluide sur tablette</b><span>Optimis√© iPad/tablette/ordinateur (pas id√©al sur smartphone).</span></div>
          </div>

          <div class="hint" style="margin-top:14px">
            Conseil : si tu utilises l‚Äôapp sur smartphone, l‚Äôexp√©rience est moins confortable (√©cran trop petit).
          </div>
        </div>
      </section>

      <!-- AUTH -->
      <aside class="card auth">
        <div class="authHead">
          <div class="logo" style="width:46px;height:46px;border-radius:16px">
            <img src="icons/icon-192.png" alt="">
          </div>
          <div>
            <h2>Connexion</h2>
            <div class="sub">Acc√®de √† l‚Äôessai gratuit, ou active ta licence.</div>
          </div>
        </div>

        <div class="msg" id="msg"></div>

        <div class="tabs" role="tablist" aria-label="Connexion ou cr√©ation de compte">
          <button class="tab active" id="tabLogin" type="button">Se connecter</button>
          <button class="tab" id="tabSignup" type="button">Cr√©er un compte</button>
        </div>

        <div class="panel active" id="panelLogin">
          <label>Email</label>
          <input id="emailLogin" type="email" autocomplete="email" placeholder="ex: prenom.nom@email.com" />
          <label>Mot de passe</label>
          <input id="passwordLogin" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

          <div class="row">
            <button class="btn" id="btnLogin" disabled>Se connecter</button>
          </div>

          <div class="row" style="justify-content:space-between">
            <button class="link" id="btnReset" type="button">Mot de passe perdu</button>
          </div>

          <div class="hint">
            Apr√®s clic, v√©rifie aussi les <b>spams / ind√©sirables</b> si tu ne vois pas l‚Äôemail.
          </div>
        </div>

        <div class="panel" id="panelSignup">
          <label>Email</label>
          <input id="emailSignup" type="email" autocomplete="email" placeholder="ex: prenom.nom@email.com" />
          <label>Mot de passe</label>
          <input id="passwordSignup" type="password" autocomplete="new-password" placeholder="6 caract√®res minimum" />
          <label>Confirmer le mot de passe</label>
          <input id="passwordSignup2" type="password" autocomplete="new-password" placeholder="R√©p√®te le mot de passe" />

          <div class="row">
            <button class="btn2" id="btnSignup" disabled>Cr√©er un compte</button>
          </div>

          <div class="hint">
            L‚Äôessai gratuit d√©marre juste apr√®s la cr√©ation du compte (10 minutes).
          </div>
        </div>

        <div class="fine">En cr√©ant un compte, tu acceptes d‚Äôutiliser l‚Äôapp sur iPad/tablette/ordinateur (smartphone non recommand√©).</div>

        <footer>D√©velopp√© par <b>Marco Moreira-Perriard</b></footer>
      </aside>
    </div>
  </div>

  <script type="module">
    import { login, signup, resetPassword } from "./js/auth.js";
    import { ensureUserProfile, computeAccess, enforceSingleDevice } from "./js/license.js";

    const $ = (id)=>document.getElementById(id);
    const msg = $("msg");

    const tabLogin = $("tabLogin");
    const tabSignup = $("tabSignup");
    const panelLogin = $("panelLogin");
    const panelSignup = $("panelSignup");

    const emailLogin = $("emailLogin");
    const passwordLogin = $("passwordLogin");
    const btnLogin = $("btnLogin");

    const emailSignup = $("emailSignup");
    const passwordSignup = $("passwordSignup");
    const passwordSignup2 = $("passwordSignup2");
    const btnSignup = $("btnSignup");

    function show(type, text){
      msg.className = "msg " + (type==="ok" ? "ok" : "err");
      msg.textContent = text;
      msg.style.display = "block";
    }
    function clearMsg(){ msg.style.display = "none"; }

    function setTab(mode){
      clearMsg();
      const isLogin = mode === "login";
      tabLogin.classList.toggle("active", isLogin);
      tabSignup.classList.toggle("active", !isLogin);
      panelLogin.classList.toggle("active", isLogin);
      panelSignup.classList.toggle("active", !isLogin);
    }
    tabLogin.onclick = ()=>setTab("login");
    tabSignup.onclick = ()=>setTab("signup");

    function canLogin(){
      return emailLogin.value.trim().includes("@") && passwordLogin.value.length >= 1;
    }
    function canSignup(){
      const e = emailSignup.value.trim();
      const p1 = passwordSignup.value;
      const p2 = passwordSignup2.value;
      return e.includes("@") && p1.length >= 6 && p1 === p2;
    }
    function refreshButtons(){
      btnLogin.disabled = !canLogin();
      btnSignup.disabled = !canSignup();
    }
    [emailLogin,passwordLogin,emailSignup,passwordSignup,passwordSignup2].forEach(el=>{
      el.addEventListener("input", refreshButtons);
    });
    refreshButtons();

    async function afterAuth(user){
      if(!navigator.onLine){
        show("err","Connexion internet requise pour la premi√®re connexion.");
        return;
      }

      // ‚úÖ BLOQUE tant que l‚Äôemail n‚Äôest pas v√©rifi√©
      if(!user.emailVerified){
        location.href = "./verify.html";
        return;
      }

      await enforceSingleDevice(user);
      const profile = await ensureUserProfile(user);
      const access = computeAccess(profile);
      location.href = access.allowed ? "./app.html" : "./activate.html";
    }

    btnLogin.onclick = async ()=>{
      clearMsg();
      try{
        const email = emailLogin.value.trim();
        const pass = passwordLogin.value;
        const user = await login(email, pass);
        await afterAuth(user);
      }catch(e){
        show("err", e?.message || "Erreur de connexion");
      }
    };

    btnSignup.onclick = async ()=>{
      clearMsg();
      try{
        const email = emailSignup.value.trim();
        const p1 = passwordSignup.value;
        const p2 = passwordSignup2.value;

        if(p1.length < 6) throw new Error("Mot de passe : 6 caract√®res minimum");
        if(p1 !== p2) throw new Error("Les mots de passe ne correspondent pas.");

        await signup(email, p1);

        // ‚úÖ Compte cr√©√© + email de v√©rification envoy√© -> on force le passage par verify.html
        show("ok","Compte cr√©√©. V√©rifie ton email (spams/ind√©sirables) pour d√©marrer l‚Äôessai.");
        setTimeout(()=>location.href="./verify.html", 600);

      }catch(e){
        show("err", e?.message || "Erreur de cr√©ation de compte");
      }
    };

    $("btnReset").onclick = async ()=>{
      clearMsg();
      try{
        const email = emailLogin.value.trim();
        if(!email) throw new Error("Entre ton email d‚Äôabord (onglet Se connecter).");
        await resetPassword(email);
        show("ok", "Email de r√©initialisation envoy√©. V√©rifie ta bo√Æte mail et aussi les spams/ind√©sirables.");
      }catch(e){
        show("err", e?.message || "Impossible d'envoyer l'email");
      }
    };
  </script>
</body>
</html>




